---
title: "R Notebook"
output: html_notebook
---

# Functions and files used from Mortality 
```{r, message=FALSE}
# Read in new Social Determinants definitions
SocialDeterminants <- read_csv("SocialDeterminants.csv")

final.determinants <- SocialDeterminants[SocialDeterminants$Keep == 1,]["Code"]
final.determinants <- append(final.determinants$Code, "county_fips", after = 0)

# Load all data
chr.data.2019 <- readRDS("chr.data.2019.rds")
chr.data.2019 <- chr.data.2019 %>%
  as_data_frame %>%
  select(final.determinants)

# Load name map and its inverse
chr.namemap.2019 <- SocialDeterminants %>% select("Code", "Name")
chr.namemap.2019 <- column_to_rownames(chr.namemap.2019, "Code")
names(chr.namemap.2019)[1] <- "name"

geo.namemap <- readRDS("geo.namemap.rds")
geo <- subset(geo.namemap, select = -c(state_fips))
```


```{r, message=FALSE}
geo$county_fips <- str_pad(geo$county_fips, 5, pad = "0")

source("Theme.R")


km.func <- function(data.mat, cluster.num=3, seed=200) {
  
  set.seed(seed)
  cluster.num <- min(nrow(data.mat) - 1, cluster.num)
  data.mat <- na.omit(data.mat)
  
  km.result <- kmeans(dplyr::select(data.mat, -county_fips), cluster.num)
  return(
    tibble(
      county_fips = dplyr::pull(data.mat, county_fips),
      cluster = as.character(km.result$cluster)
    )
  )
}

kendall.func <- function(x.data, sd.data) {
  
  # TODO's:
  #   1. Align social determinants and "x" data by "county_fips"
  #   2. Re-separate "x column and sd data frame with select
  #   3. Do cor.test
  #   4. Rename the variables to VAR
  
  align <- dplyr::left_join(x.data, sd.data, by = "county_fips") %>% 
    dplyr::select(-dplyr::one_of(c("county_fips", "state_name", "county_name")))
  #browser()
  x <- as.numeric(dplyr::pull(align, 1))
  sd <- dplyr::select(align, -1)
  
  cor.res <- list()
  for (n in names(sd)) {
    y <- dplyr::pull(sd, n)
    if (is_character(y)) {
      # print(y)
      y <- readr::parse_number(y)
    }
    
    if (sum(is.na(y)) < 0.5 * length(y)) {
      # print(tibble(x, y, n))
      cor.res[[n]] <- cor.test(
        x = x, y = y, use = "pairwise.complete.obs", method = "kendall", exact = F
      )
    }
  }
  
  tibble(
    chr_code = names(cor.res),
    kendall_cor = sapply(cor.res, function(r) r$estimate),
    kendall_p = sapply(cor.res, function(r) r$p.value)
  )
}
```
# Import COVID-19 data from JHU github repo
```{r, message=FALSE, warning=FALSE}
# set date_of_study here
# Note that only data on the 23rd of each month from is actually collected in calculation. 
# Thus "2020-10-24" and "2020-11-22" will have the same result but "2020-11-23" will have a different result. 

# including data from 11/23 mess up the correlation calculation thus default date of study is set before 2020-11-23
date_of_study = "2020-11-15"
# date_of_study = Sys.Date()

# use population data from 2020CHR for calculation of the COVID-19 death rate
chr <- read_csv("../Data/2020CHR.csv")
chr <- chr[, -grep("Quartile", colnames(chr))]
chr <- chr[, -grep("95", colnames(chr))]
chr <- chr[, -grep("#", colnames(chr))]
popu <- subset(chr, select = c(FIPS, Population))

# Historical data
covid_hist = read.csv(text=getURL(paste0("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-22-2020.csv")))
covid_us_hist = subset(covid_hist, Country_Region == "US" & is.na(FIPS)==F)
covid_us_hist = subset(covid_us_hist, select = c(FIPS, Deaths))
covid_us_hist$FIPS <- str_pad(covid_us_hist$FIPS, 5, pad = "0")
covid_us_hist = merge(x = covid_us_hist,y = geo, by.x = "FIPS", by.y = "county_fips", all.y = TRUE)
covid_us_hist = merge(x = covid_us_hist,y = popu, by = "FIPS", all.x = TRUE)
covid_us_hist$period = "03-22-2020"

# collect data from March to Month of study on 23rd of each month
date_of_all = format(seq(as.Date("2020-03-23"), as.Date(strptime(date_of_study,"%Y-%m-%d")), by = "month"),"%m-%d-%Y")

for (i in 1:length(date_of_all)){
  covid_daily = read.csv(text=getURL(paste0("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/",date_of_all[i],".csv")))
  covid_daily = subset(covid_daily,Country_Region == "US" & is.na(FIPS)==F)
  covid_daily = subset(covid_daily, select = c(FIPS, Deaths))
  covid_daily$FIPS <- str_pad(covid_daily$FIPS, 5, pad = "0")
  covid_daily = merge(x = covid_daily,y = geo, by.x = "FIPS", by.y = "county_fips", all.y = TRUE)
  covid_daily = merge(x = covid_daily,y = popu, by = "FIPS", all.x = TRUE)
  covid_daily$period = date_of_all[i]
  covid_us_hist <- rbind(covid_us_hist, covid_daily)
}

# calculation of death rate
covid_us_hist <- dplyr::rename(covid_us_hist, c(county_fips = FIPS, death_num = Deaths, population = Population))
covid_us_hist$death_rate <- covid_us_hist$death_num/covid_us_hist$population*100000
covid.data <- covid_us_hist %>% drop_na(death_num,population)
```

# Set choice of state

```{r}
state_choice = "OH"

state.list <- state.abb
names(state.list) <- state.name
```

# Clustering to get risk groups

```{r, warning=FALSE}
# raw clusters
cluster.raw <- covid.data %>%
                 dplyr::filter(state_abbr == state_choice) %>%
                 tidyr::drop_na(county_fips) %>%
                 dplyr::select(county_fips, death_rate, period) %>%
                 dplyr::group_by(period) %>% 
                 dplyr::mutate(id=1:n()) %>%
                 tidyr::spread(key = period, value = death_rate) %>%
                 dplyr::arrange(county_fips) %>%
                 km.func(3)

# average clusters        
avg.cluster.raw <- covid.data %>%
                     dplyr::filter(state_abbr == state_choice) %>%
                     dplyr::right_join(cluster.raw, by = "county_fips") %>%
                     dplyr::group_by(period, cluster) %>%
                       dplyr::summarise(
                         death_rate = sum(death_num) / sum(population) * 10^5,
                         count = n() ) %>%
                       dplyr::ungroup()

# count of each risk group
cluster.map <- avg.cluster.raw %>%
                 dplyr::filter(period == tail(date_of_all, n=1)) %>%
                 dplyr::arrange(death_rate) %>%
                 dplyr::mutate(ord = as.character(1:n())) %>%
                 dplyr::select(-c(period, death_rate)) %>%
                 textshape::column_to_rownames("cluster")

# osrt clusters
cluster.ord <- dplyr::mutate(cluster.raw, cluster = cluster.map[cluster, "ord"])
avg.cluster.ord <- dplyr::mutate(avg.cluster.raw, cluster = cluster.map[cluster, "ord"])

# get number of clusters
nclusters <- max(cluster.raw$cluster)
```

# Trend Plot: Risk Groups VS National

```{r}
# aggregate to get national death rate
nation <- aggregate(cbind(covid.data$death_num, covid.data$population), by=list(period=covid.data$period), FUN=sum)
nation <- rename(nation,c(death_num = V1,population=V2))
nation$death_rate <- nation$death_num/nation$population*100000
        
nation$cluster <- "National"
nation$count <- NA
nation <- subset(nation, select = c(period,cluster,death_rate,count))

# combine national data and risk groups for trend plot
total.data <- rbind(avg.cluster.ord,nation)

total.data$cluster[total.data$cluster == 1] <- "1: Low"
total.data$cluster[total.data$cluster == 2] <- "2: Medium"
total.data$cluster[total.data$cluster == 3] <- "3: High"

line_plot <- ggplot(
               total.data,        
               aes(x = period, 
                   y = death_rate, 
                   color = cluster,
                   group = cluster) ) + 
             geom_line(size = 1.5) + 
             geom_point(color = "#565254", 
                        shape = 21, 
                        fill = "#f7f7f7", 
                        size = 2) + 
             scale_color_manual(values = theme.categorical.colors.accent(nclusters)) +
             theme.line.mort() + 
             theme(legend.position = "left") + 
             guides(color = guide_legend(reverse = T,
                                         title = "Risk Group:")) +
             labs(fill = "Cluster", 
                  color = "Cluster",
                  title = paste("Deaths of COVID-19 Trends for Risk Groups across", names(which(state.list == state_choice))),
                  caption = "Mortality Data: JHU CSSE COVID-19 Data\nFeature Data: County Health Rankings\nAnalysis: The Rensselaer IDEA") + 
             ylab("COVID-19 Deaths per 100,000")
line_plot
```
# Generate kendall correlation coefficients between mortality rate/risk groups and social determinants

```{r, warning=FALSE}
# extract death rate data for selected state
mort.rate <- covid.data %>% 
               dplyr::filter( 
                 state_abbr == state_choice,
                 period == tail(date_of_all, n=1) ) %>%
               dplyr::select(county_fips, death_rate)

# generate raw kendall correlation from mort.rate and chr.data.2019
mort.kendall.cor <- mort.rate %>% 
                 dplyr::mutate(VAR = death_rate) %>%
                 kendall.func(chr.data.2019) %>%
                 dplyr::mutate(
                   DIR = dplyr::if_else(
                           kendall_cor <= 0,
                           "Protective",
                           "Destructive"),
                   chr_code = chr.namemap.2019[chr_code, 1]) %>% 
                 na.omit()

# sort kendall cor
mort.kendall.cor.new <- mort.kendall.cor %>% 
                     dplyr::filter(kendall_p < 0.1) %>% 
                     dplyr::arrange(desc(kendall_cor)) %>% 
                     dplyr::top_n(15, abs(kendall_cor)) %>% 
                     dplyr::mutate(chr_code = reorder(chr_code, kendall_cor))

# generate raw kendall correlation from clusters and chr.data.2019
cluster.kendall.cor <- cluster.ord %>% 
                      kendall.func(chr.data.2019) %>%
                      na.omit()

# sort kendall cor
cluster.kendall.cor.new <- cluster.kendall.cor %>% 
                     dplyr::filter(kendall_p < 0.1) %>% 
                     dplyr::arrange(desc(kendall_cor)) %>% 
                     dplyr::top_n(15, abs(kendall_cor)) %>% 
                     dplyr::mutate(chr_code = reorder(chr_code, kendall_cor))
```

# Print list of significant social determinants to pick

```{r}
print(cluster.kendall.cor$chr_code)
```

# Select social determinant to interpret risk groups in box plot and scatter plot

```{r}
selected.determinant <- cluster.kendall.cor$chr_code[3]
print(selected.determinant)
```

# Box plot to depict risk groups

```{r}
cluster.determinant.vals <- dplyr::inner_join(
                              cluster.ord, 
                              chr.data.2019[c("county_fips", selected.determinant)],
                              by = "county_fips")

cluster.boxplots <- ggplot(cluster.determinant.vals)  + 
                    geom_boxplot(aes_string(x = "cluster", 
                                            y = selected.determinant, 
                                            color = "cluster")) +
                    xlab("Cluster") +
                    ylab(chr.namemap.2019[selected.determinant,]) +
                    theme(legend.position = "none")

cluster.boxplots
```

# Scatter Plot to show the distribution of risk group

```{r}
mort.mat <- covid_us_hist %>%
              dplyr::filter(state_abbr == state_choice) %>%
              tidyr::drop_na(county_fips) %>%
              dplyr::select(county_fips, death_rate, period) %>%
              tidyr::spread(key = period, value = death_rate) %>%
              dplyr::arrange(county_fips) %>%
              dplyr::select(county_fips, tail(date_of_all, n=1))

# for scatter need to append most recent deathrate
cluster.determinant.vals.deathrate <- dplyr::inner_join(
                                        cluster.determinant.vals,
                                        mort.mat,
                                        by = "county_fips")

colnames(cluster.determinant.vals.deathrate)[colnames(cluster.determinant.vals.deathrate)==tail(date_of_all, n=1)] <- "mortality_rate"

cluster.scatter <- ggplot(cluster.determinant.vals.deathrate)  +
  geom_point(aes_string(y = selected.determinant, x = "mortality_rate", color = "cluster")) +
  ylab(chr.namemap.2019[selected.determinant,]) +
  xlab("Mortality Rate") +
  labs(color = "Cluster\n")

cluster.scatter
```

# Plot Kendall

```{r}
if(nrow(mort.kendall.cor.new) > 0) {
  mort.kendall.cor.new %>% 
    ggplot(
      aes(x = chr_code, 
          y = kendall_cor, 
          color = DIR, 
          fill = DIR) ) + 
    
    # Lolipop chart
    geom_point(
      stat = 'identity', 
      size = 12) + 
    geom_segment(
      size = 1,
      aes(y = 0, 
          x = chr_code, 
          yend = kendall_cor, 
          xend = chr_code, 
          color = DIR) ) +
    geom_text(
      aes(label = chr_code, 
          y = ifelse(DIR == "Protective", 0.1, -0.1),
          hjust = ifelse(DIR == "Protective", 0, 1) ), 
      color = "#565254", 
      size = 4 ) +
    geom_text(
      aes(label = round(kendall_cor, 2)), 
      color = "#565254", 
      size = 3 ) +
    
    # Coordinates
    coord_flip() + 
    scale_y_continuous(breaks = seq(-1, 1, by = .2), limits = c(-1, 1)) +
                
    # Themes
    geom_hline(yintercept = .0, linetype = "dashed") + 
    labs(y = "Correlation",
         x = NULL,
         title = paste("Factors Associated with COVID-19 Deaths for", names(which(state.list == state_choice))),
         fill = "Relationship",
         color = "Relationship" ) +
    theme_minimal() +
    theme.text() + 
    theme.background() + 
    theme(axis.text.y = element_blank(),
          axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 12),
          panel.grid.major.y = element_blank() ) + 
    theme(legend.position="top")
  
  # cannot figure out how to change the height of ggplot
  # but this ggsave function can download the kendall plot with specific height and width
  # ggsave(paste(state_choice, "_kendall.png", sep=""), width = 6, height = 10)
  
} else {
  #Display something else when there are no significant SD
  
  # empty plot, then put text on it ?
  ggplot() + 
  theme_void() +
  geom_text(
    aes(x = 0, 
        y = 0, 
        label="There are no significant social determinants."))
            
}
```

# Construct regional divisions on kendall correaltion

```{r, warning=FALSE, message=FALSE}

states <- state.region
names(states) <- state.abb

# Data Frames of list of social determinants for each state, destructive and protective repectively
# each state has one column
# index is ranking of kendall cor
aggregated_des = data.frame(matrix(ncol=0,nrow=0))
aggregated_pro = data.frame(matrix(ncol=0,nrow=0))

# Data frames to merge ranking of kendall cor of all state into one mega df for later aggregation, destructive and protective repectively
des_determinants = data.frame(matrix(ncol=0,nrow=0))
pro_determinants = data.frame(matrix(ncol=0,nrow=0))

for (state in names(states)) {
  
  if (!state %in% c("HI", "DE")){
    
    mort.rate <- covid.data %>% dplyr::filter(
      state_abbr == state,
      period == tail(date_of_all, n=1) ) %>%
      dplyr::select(county_fips, death_rate)
    
    kendall.cor <- mort.rate %>% 
      dplyr::mutate(VAR = death_rate) %>%
      kendall.func(chr.data.2019) %>%
      dplyr::mutate(
        DIR = dplyr::if_else(
          kendall_cor <= 0,
          "Protective",
          "Destructive"
        ),
        chr_code = chr.namemap.2019[chr_code, 1]
      ) %>% na.omit()
    
    # Sort by kendall.cor
    kendall.cor.new <- kendall.cor %>% 
      dplyr::filter(kendall_p < 0.1) %>% 
      dplyr::arrange(desc(kendall_cor)) %>% 
      dplyr::top_n(15, abs(kendall_cor)) %>% 
      dplyr::mutate(chr_code = reorder(chr_code, kendall_cor))
        
    kendall.des <- kendall.cor.new[kendall.cor.new$DIR == "Destructive",]
    
    if (nrow(kendall.des) > 0){
      kendall.des <- select(kendall.des, c(chr_code, kendall_cor))
      kendall.des$des_rank <- 1:nrow(kendall.des)
      kendall.des <- kendall.des[, c(3, 1, 2)]
      kendall.des$state <- state
      kendall.des$region <- states[state]
      
      if (ncol(des_determinants) == 0) {
        des_determinants <- kendall.des
      }else {
        des_determinants <- rbind(des_determinants, kendall.des)
      }
      
      if (ncol(aggregated_des) == 0) {
        aggregated_des <- kendall.des
      }else {
        aggregated_des <- merge(aggregated_des, kendall.des, by="des_rank", all = T)
      }

      names(aggregated_des)[names(aggregated_des) == "chr_code"] <- paste(state, "_chr_code", sep = "")
      names(aggregated_des)[names(aggregated_des) == "kendall_cor"] <- paste(state, "_kendall_cor", sep = "")
    }
    
    kendall.pro <- kendall.cor.new[kendall.cor.new$DIR == "Protective",]
    
    if (nrow(kendall.pro) > 0){
      kendall.pro <- select(kendall.pro, c(chr_code, kendall_cor))
      kendall.pro$pro_rank <- 1:nrow(kendall.pro)
      kendall.pro <- kendall.pro[, c(3, 1, 2)]
      kendall.pro$state <- state
      kendall.pro$region <- states[state]
      
      if (ncol(pro_determinants) == 0) {
        pro_determinants <- kendall.pro
      }else {
        pro_determinants <- rbind(pro_determinants, kendall.pro)
      }
      
      if (ncol(aggregated_pro) == 0) {
        aggregated_pro <- kendall.pro
      }else {
        aggregated_pro <- merge(aggregated_pro, kendall.pro, by="pro_rank", all = T)
      }
      names(aggregated_pro)[names(aggregated_pro) == "chr_code"] <- paste(state, "_chr_code", sep = "")
      names(aggregated_pro)[names(aggregated_pro) == "kendall_cor"] <- paste(state, "_kendall_cor", sep = "")
    }
    
  }
}

# each social determinant has one row
# add region data and aggregate mean rank/count/mean correlation/state list
aggregated_des_deter <- des_determinants %>%
  dplyr::group_by(chr_code) %>%
  dplyr::summarize(des_mean_rank = mean(des_rank, na.rm = TRUE),
                   des_count = n(),
                   des_mean_cor = mean(kendall_cor, na.rm = TRUE),
                   des_states = paste(state,collapse=' '),
                   `des Northeast` = paste(sum(region == "Northeast", na.rm = TRUE),"/ 9",collapse = ''),
                   `des South` = paste(sum(region == "South", na.rm = TRUE),"/ 16",collapse = ''),
                   `des North Central` = paste(sum(region == "North Central", na.rm = TRUE),"/ 12",collapse = ''),
                   `des West` = paste(sum(region == "West", na.rm = TRUE),"/ 13",collapse = '')) %>%
  dplyr::arrange(desc(des_count), desc(des_mean_cor), des_mean_rank)

# each social determinant has one row
aggregated_pro_deter <- pro_determinants %>%
  dplyr::group_by(chr_code) %>%
  dplyr::summarize(pro_mean_rank = mean(pro_rank, na.rm = TRUE),
                   pro_count = n(),
                   pro_mean_cor = mean(kendall_cor, na.rm = TRUE),
                   pro_states = paste(state,collapse=' '),
                   `pro Northeast` = paste(sum(region == "Northeast", na.rm = TRUE),"/ 9",collapse = ''),
                   `pro South` = paste(sum(region == "South", na.rm = TRUE),"/ 16",collapse = ''),
                   `pro North Central` = paste(sum(region == "North Central", na.rm = TRUE),"/ 12",collapse = ''),
                   `pro West` = paste(sum(region == "West", na.rm = TRUE),"/ 13",collapse = '')) %>%
  dplyr::arrange(desc(pro_count), pro_mean_cor, desc(pro_mean_rank))

# each social determinant has one row
# merge both destructive and protective into one df for comparison
aggregated_determinants <- merge(aggregated_des_deter, aggregated_pro_deter, by="chr_code", all = T)

# write.csv(aggregated_determinants,"aggregated_determinants.csv", row.names = FALSE)
# write.csv(aggregated_des,"aggregated_des.csv", row.names = FALSE)
# write.csv(aggregated_pro,"aggregated_pro.csv", row.names = FALSE)

# helper to extract state list for each region
# string <- ""
# for (state in names(states)) {
#   if (!state %in% c("HI", "DE")){
#     if (states[state] == "West"){
#       string <- paste(string, state, collapse = " ")
#     }
#   }
# }
# print(string)
```

# Region Divisions Reference

```{r}
library("kableExtra")

# helper to extract state list for each region

divisions = data.frame(matrix(ncol=0,nrow=4))
divisions["Region"] = regions
divisions["#"] = c(9,16,12,13)

regions = c("Northeast", "South", "North Central", "West")
for (region in regions) {
  string <- ""
  for (state in names(states)) {
    if (!state %in% c("HI", "DE")){
      if (states[state] == region){
        string <- paste(string, state, collapse = " ")
      }
    }
  }
  divisions[divisions$Region==region, "States"] = string
}

divisions %>%
  kbl() %>%
  kable_styling()

```

# Some interesting/confusing findings based on kendall correlation coefficients under regional divisions

* Median Household Income is destructive only in the Northeast region but protective in other three regions.
* Median Household Income is protective in 9 out of 16 states (56.25%) of the South region.
* Uninsured Children is protective in 4 out of 9 (44.44%) states of the Northeast region.
* Rural is destructive in LA with a correlation of 0.2 but protective in the other states.
* Rural is protective in 7 out of 9 (77.78%) states of the Northeast region.
* Older Than 65 is destructive in the South and North Central but protective in the Northeast and West.

## Below are some findings specificly related to the South region as the South region has a different pattern than all other 3 regions.

* Excessive Drinking is the most protective factor of the South region (in 9 out of 16 states) but does not display a trend in other regions.
* Socio-Economic is the most destructive factor of the South region (in 9 out of 16 states) but does not display a trend in other regions.
* Diabetes Prevalence is destructive in 6 out of 16 states in the South region but does not display a trend in other regions.
* The South region is destructively affected most by poverty/poor health/diabetes related social determinants but  protectively affected most by income indicators.
* Social Associations is destructive in over 50% of the states in all Northeast(5/9), North Central(7/12) and West(6/13) regions but not so scary in the South(2/16) region.
